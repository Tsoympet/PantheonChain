name: Build Installers

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  BUILD_TYPE: Release

jobs:
  test-installer-scripts:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Test Installer Scripts Exist
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          test -f installers/linux/build.sh
          test -f installers/linux/deb/control
        elif [ "$RUNNER_OS" == "Windows" ]; then
          test -f installers/windows/build.ps1
          test -f installers/windows/nsis/parthenon.nsi
        elif [ "$RUNNER_OS" == "macOS" ]; then
          test -f installers/macos/build.sh
          test -f installers/macos/dmg/parthenon.dmgproj
        fi
      shell: bash
    
    - name: Validate Installer Scripts
      run: |
        echo "Installer scripts validated for $RUNNER_OS"

    - name: Validate installers workflow YAML
      if: runner.os == 'Linux'
      shell: bash
      run: |
        python -m pip install --quiet pyyaml
        python -c "import pathlib,yaml; yaml.safe_load(pathlib.Path('.github/workflows/installers.yml').read_text(encoding='utf-8')); print('OK')"

    - name: Linux installer script regression checks
      if: runner.os == 'Linux'
      run: |
        bash -n installers/linux/build-rpm.sh
        if rg -n '^\s*local\s+' installers/linux/build-rpm.sh; then
          echo "Unexpected local variable declarations found in installers/linux/build-rpm.sh"
          exit 1
        fi
      shell: bash

    - name: Windows installer PowerShell parse check
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $tokens = $null
        $errs = $null
        [void][System.Management.Automation.Language.Parser]::ParseFile('installers/windows/build.ps1', [ref]$tokens, [ref]$errs)
        if ($errs) {
          $errs | ForEach-Object { "{0}: {1}" -f $_.Extent.StartLineNumber, $_.Message }
          exit 1
        }
        Write-Host 'OK'

    - name: NSIS File references exist
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $nsi = Get-Content installers/windows/parthenon-installer.nsi
        $missing = $false
        foreach ($line in $nsi) {
          if ($line -match '^\s*File\s+"([^"]+)"') {
            $rel = $matches[1] -replace '\\', '/'
            # Skip paths with NSIS variables (e.g. ${NSISDIR}) or build artifacts
            if ($rel -match '\$\{' -or $rel -match '/build/') { continue }
            $abs = Join-Path 'installers/windows' $rel
            $resolved = [System.IO.Path]::GetFullPath($abs)
            if (-not (Test-Path $resolved)) {
              Write-Host "NSIS references missing file: $rel (resolved: $resolved)" -ForegroundColor Red
              $missing = $true
            }
          }
        }
        if ($missing) { exit 1 }
        Write-Host 'All NSIS source-file references resolved OK'
