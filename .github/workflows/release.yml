name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Initialize submodules
      run: git submodule update --init --recursive
    
    - name: Install NSIS
      shell: pwsh
      run: |
        choco install nsis -y --no-progress
        $nsisPaths = @(
          "C:\Program Files (x86)\NSIS",
          "C:\Program Files\NSIS",
          "C:\ProgramData\chocolatey\bin",
          "C:\ProgramData\chocolatey\lib\nsis\tools"
        )
        $resolved = $nsisPaths | Where-Object { Test-Path (Join-Path $_ "makensis.exe") } | Select-Object -First 1
        if (-not $resolved) {
          throw "NSIS installation directory not found. Checked: $($nsisPaths -join ', ')"
        }

        "NSIS_HOME=$resolved" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        "$resolved" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

        # GitHub PATH updates apply to subsequent steps, but we also need access right now
        $env:PATH = "$resolved;$env:PATH"

    - name: Verify NSIS availability
      shell: pwsh
      run: |
        where.exe makensis
        $makensis = Get-Command makensis -ErrorAction Stop
        & $makensis.Source /VERSION

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
    
    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel
    
    - name: Run Tests
      run: cd build && ctest -C ${{env.BUILD_TYPE}} --output-on-failure

    - name: Ensure default daemon config exists for packaging
      shell: pwsh
      run: |
        $configPath = "build/clients/core-daemon/parthenond.conf"
        $sourceConfigPath = "clients/core-daemon/parthenond.conf"

        if (-Not (Test-Path $configPath)) {
          New-Item -ItemType Directory -Path (Split-Path -Parent $configPath) -Force | Out-Null

          if (Test-Path $sourceConfigPath) {
            Copy-Item $sourceConfigPath $configPath -Force
          }
          else {
            $defaultConfig = @(
              "# Auto-generated default configuration for release packaging",
              "network_port=8333",
              "max_connections=125",
              "network_timeout=30",
              "rpc_enabled=true",
              "rpc_port=8332",
              "rpc_user=parthenonrpc",
              "rpc_password=change-me",
              "data_dir=/var/lib/parthenon",
              "log_level=info",
              "mining_enabled=false"
            ) -join "`n"
            Set-Content -Path $configPath -Value $defaultConfig
          }
        }

    - name: Build NSIS Installer
      shell: pwsh
      run: |
        Get-Command makensis -ErrorAction Stop | Out-Null
        cd installers/windows
        pwsh -ExecutionPolicy Bypass -File build.ps1
    
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: installers/windows/*.exe

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Initialize submodules
      run: git submodule update --init --recursive
    
    - name: Install Dependencies
      run: brew install cmake openssl boost qt
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
    
    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel
    
    - name: Run Tests
      run: cd build && ctest -C ${{env.BUILD_TYPE}} --output-on-failure
    
    - name: Create DMG
      run: |
        cd installers/macos
        chmod +x build.sh
        ./build.sh
    
    - name: Upload macOS DMG
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: installers/macos/*.dmg

  build-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix:
        package: [deb, rpm]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Initialize submodules
      run: git submodule update --init --recursive
    
    - name: Install Dependencies
      timeout-minutes: 15
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          rpm cmake g++ libssl-dev libboost-all-dev qt6-base-dev
        cmake --version
        if ! dpkg --compare-versions "$(cmake --version | head -n1 | awk '{print $3}')" ge 3.15; then
          echo "CMake >= 3.15 is required for Linux packaging"
          exit 1
        fi

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
    
    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel
    
    - name: Run Tests
      run: cd build && ctest -C ${{env.BUILD_TYPE}} --output-on-failure

    - name: Ensure default daemon config exists for packaging
      run: |
        CONFIG_PATH="build/clients/core-daemon/parthenond.conf"
        SOURCE_CONFIG_PATH="clients/core-daemon/parthenond.conf"
        EXAMPLE_CONFIG_PATH="parthenond.conf.example"

        if [ ! -f "$CONFIG_PATH" ]; then
          mkdir -p "$(dirname "$CONFIG_PATH")"

          if [ -f "$SOURCE_CONFIG_PATH" ]; then
            cp "$SOURCE_CONFIG_PATH" "$CONFIG_PATH"
          elif [ -f "$EXAMPLE_CONFIG_PATH" ]; then
            cp "$EXAMPLE_CONFIG_PATH" "$CONFIG_PATH"
          else
            cat > "$CONFIG_PATH" << 'EOF'
# Auto-generated default configuration for release packaging
network_port=8333
max_connections=125
network_timeout=30
rpc_enabled=true
rpc_port=8332
rpc_user=parthenonrpc
rpc_password=change-me
data_dir=/var/lib/parthenon
log_level=info
mining_enabled=false
EOF
          fi
        fi

    - name: Build Package
      run: |
        cd installers/linux
        chmod +x build.sh
        ./build.sh ${{ matrix.package }}
    
    - name: Upload Linux Package
      uses: actions/upload-artifact@v4
      with:
        name: linux-${{ matrix.package }}
        path: installers/linux/*.${{ matrix.package }}

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    env:
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
    
    - name: Generate Checksums
      run: |
        cd installers/checksums
        chmod +x generate-checksums.sh
        ./generate-checksums.sh ../../windows-installer/*.exe ../../macos-dmg/*.dmg ../../linux-deb/*.deb ../../linux-rpm/*.rpm
    
    - name: Sign Artifacts (if GPG key available)
      if: env.GPG_PRIVATE_KEY != ''
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
      run: |
        if [ -z "$GPG_PRIVATE_KEY" ]; then
          echo "GPG private key not configured; skipping artifact signing"
          exit 0
        fi

        echo "$GPG_PRIVATE_KEY" | gpg --import
        cd installers/checksums
        chmod +x sign-release.sh
        GPG_KEY_ID=$GPG_KEY_ID ./sign-release.sh ../../windows-installer/*.exe ../../macos-dmg/*.dmg ../../linux-deb/*.deb ../../linux-rpm/*.rpm
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        files: |
          windows-installer/*.exe
          windows-installer/*.exe.asc
          macos-dmg/*.dmg
          macos-dmg/*.dmg.asc
          linux-deb/*.deb
          linux-deb/*.deb.asc
          linux-rpm/*.rpm
          linux-rpm/*.rpm.asc
          installers/checksums/parthenon-*-checksums.txt
        body: |
          # ParthenonChain ${{ github.ref_name }}
          
          **Production-ready blockchain with three native assets, Schnorr signatures, and EVM-compatible smart contracts.**
          
          ## ğŸ“¥ Downloads
          
          Choose the installer for your operating system:
          
          ### ğŸªŸ Windows
          - **[parthenon-*-windows-x64-setup.exe](https://github.com/Tsoympet/PantheonChain/releases/latest/download/parthenon-1.0.0-windows-x64-setup.exe)** - Windows 10/11 installer (NSIS)
          
          ### ğŸ macOS
          - **[parthenon-*-macos.dmg](https://github.com/Tsoympet/PantheonChain/releases/latest/download/parthenon-1.0.0-macos.dmg)** - macOS disk image (Intel & Apple Silicon)
          
          ### ğŸ§ Linux
          - **[parthenon_*_amd64.deb](https://github.com/Tsoympet/PantheonChain/releases/latest/download/parthenon_1.0.0_amd64.deb)** - Debian/Ubuntu package
          - **[parthenon-*.rpm](https://github.com/Tsoympet/PantheonChain/releases/latest/download/parthenon-1.0.0-1.el8.x86_64.rpm)** - RPM package (RHEL/Fedora/CentOS)
          
          ## ğŸ“– Installation Guides
          
          - **[Quick Start Guide](QUICK_START.md)** - Get started in minutes
          - **[Download Instructions](DOWNLOAD.md)** - Detailed installation steps
          - **[Full Documentation](README.md)** - Complete user guide
          
          ## ğŸ” Verification
          
          **Verify your download** for security:
          
          1. Download the checksums file: `parthenon-*-checksums.txt`
          2. Verify SHA-256 hash matches:
             ```bash
             # Windows (PowerShell)
             Get-FileHash -Algorithm SHA256 parthenon-*-setup.exe
             
             # macOS/Linux
             sha256sum parthenon-*.dmg
             ```
          3. Verify GPG signature (if available):
             ```bash
             gpg --verify <file>.asc <file>
             ```
          
          ## âœ¨ What's Included
          
          - **parthenond** - Full blockchain node
          - **parthenon-cli** - Command-line wallet and tools
          - **Desktop GUI** - User-friendly graphical wallet (optional)
          - **Documentation** - Complete guides and API reference
          
          ## ğŸ¯ Features
          
          - âœ… Three native tokens (TALANTON, DRACHMA, OBOLOS)
          - âœ… SHA-256d Proof-of-Work consensus
          - âœ… Schnorr signatures (BIP-340)
          - âœ… EVM-compatible smart contracts
          - âœ… Layer 2 payment channels
          - âœ… Production-ready clients for all platforms
          
          ## ğŸ“‹ System Requirements
          
          - **CPU**: 2+ cores
          - **RAM**: 4 GB minimum (8 GB recommended)
          - **Disk**: 50 GB+ SSD
          - **OS**: Windows 10+, macOS 10.15+, Ubuntu 20.04+, or equivalent
          
          ## ğŸš€ Getting Started
          
          1. Download installer for your platform
          2. Run installer and follow wizard
          3. Launch ParthenonChain
          4. Create wallet: `parthenon-cli getnewaddress`
          5. Start using ParthenonChain!
          
          See **[QUICK_START.md](QUICK_START.md)** for detailed instructions.
          
          ## ğŸ†˜ Support
          
          - ğŸ“– [Documentation](README.md)
          - ğŸ’¬ [GitHub Discussions](https://github.com/Tsoympet/PantheonChain/discussions)
          - ğŸ› [Report Issues](https://github.com/Tsoympet/PantheonChain/issues)
          
          **Full Changelog**: https://github.com/Tsoympet/PantheonChain/compare/v0.9.0...${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
