name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install NSIS
      shell: pwsh
      run: |
        choco install nsis -y --no-progress

    - name: Initialize submodules
      run: git submodule update --init --recursive

    - name: Verify NSIS Installation
      shell: pwsh
      run: |
        $paths = @(
          "C:\ProgramData\chocolatey\bin",
          "C:\ProgramData\chocolatey\lib\nsis\tools",
          "C:\Program Files (x86)\NSIS",
          "C:\Program Files\NSIS"
        ) | Where-Object { Test-Path $_ }

        foreach ($pathEntry in $paths) {
          $pathEntry | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        }

        $makensis = $paths |
          ForEach-Object { Join-Path $_ "makensis.exe" } |
          Where-Object { Test-Path $_ } |
          Select-Object -First 1

        if (-not $makensis) {
          Write-Error "makensis.exe not found after NSIS install"
        }

        "NSIS_HOME=$([System.IO.Path]::GetDirectoryName($makensis))" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

        & $makensis /VERSION

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
    
    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel
    
    - name: Run Tests
      run: cd build && ctest -C ${{env.BUILD_TYPE}} --output-on-failure

    - name: Ensure default daemon config exists for packaging
      shell: pwsh
      run: |
        $configPath = "build/clients/core-daemon/parthenond.conf"
        $sourceConfigPath = "clients/core-daemon/parthenond.conf"

        if (-Not (Test-Path $configPath)) {
          New-Item -ItemType Directory -Path (Split-Path -Parent $configPath) -Force | Out-Null

          if (Test-Path $sourceConfigPath) {
            Copy-Item $sourceConfigPath $configPath -Force
          }
          else {
            $defaultConfig = @(
              "# Auto-generated default configuration for release packaging",
              "network_port=8333",
              "max_connections=125",
              "network_timeout=30",
              "rpc_enabled=true",
              "rpc_port=8332",
              "rpc_user=parthenonrpc",
              "rpc_password=change-me",
              "data_dir=/var/lib/parthenon",
              "log_level=info",
              "mining_enabled=false"
            ) -join "`n"
            Set-Content -Path $configPath -Value $defaultConfig
          }
        }

    - name: Build NSIS Installer
      shell: pwsh
      run: |
        if (-not (Get-Command makensis -ErrorAction SilentlyContinue)) {
          Write-Error "makensis is not available on PATH"
        }
        where.exe makensis
        if ($env:NSIS_HOME) {
          Write-Host "NSIS_HOME=$env:NSIS_HOME"
        }
        cd installers/windows
        pwsh -ExecutionPolicy Bypass -File build.ps1
    
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: installers/windows/*.exe

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Initialize submodules
      run: git submodule update --init --recursive
    
    - name: Install Dependencies
      run: brew install cmake openssl boost qt
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
    
    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel
    
    - name: Run Tests
      run: cd build && ctest -C ${{env.BUILD_TYPE}} --output-on-failure
    
    - name: Create DMG
      run: |
        cd installers/macos
        chmod +x build.sh
        ./build.sh
    
    - name: Upload macOS DMG
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: installers/macos/*.dmg

  build-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix:
        package: [deb, rpm]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Initialize submodules
      run: git submodule update --init --recursive
    
    - name: Install Dependencies
      timeout-minutes: 15
      run: |
        sudo apt-get update

        # Common Linux build dependencies used by both DEB and RPM jobs.
        sudo apt-get install -y --no-install-recommends \
          cmake g++ libssl-dev libboost-all-dev qt6-base-dev

        # RPM-specific tooling for Ubuntu runners. Some distros expose `rpmbuild`
        # via `rpm`, while others split it into `rpm-build`.
        if [ "${{ matrix.package }}" = "rpm" ]; then
          sudo apt-get install -y --no-install-recommends \
            rpm build-essential cmake g++ libssl-dev libboost-all-dev

          if ! command -v rpmbuild >/dev/null 2>&1; then
            sudo apt-get install -y --no-install-recommends rpm-build || true
          fi

          if ! command -v rpmbuild >/dev/null 2>&1; then
            echo "rpmbuild is not available on this Ubuntu image; consider using a Fedora/RHEL container for RPM packaging"
            exit 1
          fi
        fi

        cmake --version
        if ! dpkg --compare-versions "$(cmake --version | head -n1 | awk '{print $3}')" ge 3.15; then
          echo "CMake >= 3.15 is required for Linux packaging"
          exit 1
        fi

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
    
    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel
    
    - name: Run Tests
      run: cd build && ctest -C ${{env.BUILD_TYPE}} --output-on-failure

    - name: Ensure default daemon config exists for packaging
      run: |
        CONFIG_PATH="build/clients/core-daemon/parthenond.conf"
        SOURCE_CONFIG_PATH="clients/core-daemon/parthenond.conf"
        EXAMPLE_CONFIG_PATH="parthenond.conf.example"

        if [ ! -f "$CONFIG_PATH" ]; then
          mkdir -p "$(dirname "$CONFIG_PATH")"

          if [ -f "$SOURCE_CONFIG_PATH" ]; then
            cp "$SOURCE_CONFIG_PATH" "$CONFIG_PATH"
          elif [ -f "$EXAMPLE_CONFIG_PATH" ]; then
            cp "$EXAMPLE_CONFIG_PATH" "$CONFIG_PATH"
          else
            {
              echo "# Auto-generated default configuration for release packaging"
              echo "network_port=8333"
              echo "max_connections=125"
              echo "network_timeout=30"
              echo "rpc_enabled=true"
              echo "rpc_port=8332"
              echo "rpc_user=parthenonrpc"
              echo "rpc_password=change-me"
              echo "data_dir=/var/lib/parthenon"
              echo "log_level=info"
              echo "mining_enabled=false"
            } > "$CONFIG_PATH"
          fi
        fi

    - name: Validate RPM spec expansion
      if: matrix.package == 'rpm'
      run: |
        docker run --rm           -v "${{ github.workspace }}:/workspace"           -w /workspace           fedora:latest           bash -lc "dnf install -y rpm-build >/dev/null && rpmspec -P installers/linux/parthenon.spec >/tmp/parthenon.spec.expanded"

    - name: Build Package
      run: |
        if [ "${{ matrix.package }}" = "rpm" ]; then
          docker run --rm             -v "${{ github.workspace }}:/workspace"             -w /workspace/installers/linux             fedora:latest             bash -lc "dnf install -y rpm-build rpmdevtools cmake gcc-c++ openssl-devel boost-devel qt6-qtbase-devel git >/dev/null && chmod +x build.sh && ./build.sh rpm"
        else
          cd installers/linux
          chmod +x build.sh
          ./build.sh deb
        fi
    
    - name: Upload Linux Package
      uses: actions/upload-artifact@v4
      with:
        name: linux-${{ matrix.package }}
        path: installers/linux/*.${{ matrix.package }}

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    env:
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
    
    - name: Generate Checksums
      run: |
        cd installers/checksums
        chmod +x generate-checksums.sh
        ./generate-checksums.sh ../../windows-installer/*.exe ../../macos-dmg/*.dmg ../../linux-deb/*.deb ../../linux-rpm/*.rpm
    
    - name: Sign Artifacts (if GPG key available)
      if: env.GPG_PRIVATE_KEY != ''
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
      run: |
        if [ -z "$GPG_PRIVATE_KEY" ]; then
          echo "GPG private key not configured; skipping artifact signing"
          exit 0
        fi

        echo "$GPG_PRIVATE_KEY" | gpg --import
        cd installers/checksums
        chmod +x sign-release.sh
        GPG_KEY_ID=$GPG_KEY_ID ./sign-release.sh ../../windows-installer/*.exe ../../macos-dmg/*.dmg ../../linux-deb/*.deb ../../linux-rpm/*.rpm
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        files: |
          windows-installer/*.exe
          windows-installer/*.exe.asc
          macos-dmg/*.dmg
          macos-dmg/*.dmg.asc
          linux-deb/*.deb
          linux-deb/*.deb.asc
          linux-rpm/*.rpm
          linux-rpm/*.rpm.asc
          installers/checksums/parthenon-*-checksums.txt
        body: |
          # ParthenonChain ${{ github.ref_name }}
          
          **Production-ready blockchain with three native assets, Schnorr signatures, and EVM-compatible smart contracts.**
          
          ## üì• Downloads
          
          Choose the installer for your operating system:
          
          ### ü™ü Windows
          - **[parthenon-*-windows-x64-setup.exe](https://github.com/Tsoympet/PantheonChain/releases/latest/download/parthenon-1.0.0-windows-x64-setup.exe)** - Windows 10/11 installer (NSIS)
          
          ### üçé macOS
          - **[parthenon-*-macos.dmg](https://github.com/Tsoympet/PantheonChain/releases/latest/download/parthenon-1.0.0-macos.dmg)** - macOS disk image (Intel & Apple Silicon)
          
          ### üêß Linux
          - **[parthenon_*_amd64.deb](https://github.com/Tsoympet/PantheonChain/releases/latest/download/parthenon_1.0.0_amd64.deb)** - Debian/Ubuntu package
          - **[parthenon-*.rpm](https://github.com/Tsoympet/PantheonChain/releases/latest/download/parthenon-1.0.0-1.el8.x86_64.rpm)** - RPM package (RHEL/Fedora/CentOS)
          
          ## üìñ Installation Guides
          
          - **[Quick Start Guide](QUICK_START.md)** - Get started in minutes
          - **[Download Instructions](DOWNLOAD.md)** - Detailed installation steps
          - **[Full Documentation](README.md)** - Complete user guide
          
          ## üîê Verification
          
          **Verify your download** for security:
          
          1. Download the checksums file: `parthenon-*-checksums.txt`
          2. Verify SHA-256 hash matches:
             ```bash
             # Windows (PowerShell)
             Get-FileHash -Algorithm SHA256 parthenon-*-setup.exe
             
             # macOS/Linux
             sha256sum parthenon-*.dmg
             ```
          3. Verify GPG signature (if available):
             ```bash
             gpg --verify <file>.asc <file>
             ```
          
          ## ‚ú® What's Included
          
          - **parthenond** - Full blockchain node
          - **parthenon-cli** - Command-line wallet and tools
          - **Desktop GUI** - User-friendly graphical wallet (optional)
          - **Documentation** - Complete guides and API reference
          
          ## üéØ Features
          
          - ‚úÖ Three native tokens (TALANTON, DRACHMA, OBOLOS)
          - ‚úÖ SHA-256d Proof-of-Work consensus
          - ‚úÖ Schnorr signatures (BIP-340)
          - ‚úÖ EVM-compatible smart contracts
          - ‚úÖ Layer 2 payment channels
          - ‚úÖ Production-ready clients for all platforms
          
          ## üìã System Requirements
          
          - **CPU**: 2+ cores
          - **RAM**: 4 GB minimum (8 GB recommended)
          - **Disk**: 50 GB+ SSD
          - **OS**: Windows 10+, macOS 10.15+, Ubuntu 20.04+, or equivalent
          
          ## üöÄ Getting Started
          
          1. Download installer for your platform
          2. Run installer and follow wizard
          3. Launch ParthenonChain
          4. Create wallet: `parthenon-cli getnewaddress`
          5. Start using ParthenonChain!
          
          See **[QUICK_START.md](QUICK_START.md)** for detailed instructions.
          
          ## üÜò Support
          
          - üìñ [Documentation](README.md)
          - üí¨ [GitHub Discussions](https://github.com/Tsoympet/PantheonChain/discussions)
          - üêõ [Report Issues](https://github.com/Tsoympet/PantheonChain/issues)
          
          **Full Changelog**: https://github.com/Tsoympet/PantheonChain/compare/v0.9.0...${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
