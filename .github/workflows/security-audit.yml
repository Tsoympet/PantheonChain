name: Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security audit daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        submodules: recursive
    
    - name: Run dependency vulnerability scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Check for known vulnerabilities in C++ dependencies
      run: |
        echo "Scanning for known vulnerabilities..."
        # Check for outdated or vulnerable dependencies
        if [ -f "third_party/secp256k1/VERSION" ]; then
          echo "secp256k1 version: $(cat third_party/secp256k1/VERSION || echo 'unknown')"
        fi
        
        # Check for security patches needed
        echo "Checking for security updates..."
        
    - name: Static analysis with cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck
        
        echo "Running static analysis on Layer 1 (consensus-critical)..."
        cppcheck --enable=warning,style,performance,portability \
          --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --inline-suppr \
          layer1/ || echo "Static analysis found issues (non-blocking)"
        
        echo "Running static analysis on Layer 2..."
        cppcheck --enable=warning,style,performance,portability \
          --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --inline-suppr \
          layer2/ || echo "Static analysis found issues (non-blocking)"
    
    - name: Check for hardcoded secrets
      run: |
        echo "Scanning for hardcoded secrets and credentials..."
        
        # Check for common patterns that might be secrets
        if grep -r -i "password\s*=\s*['\"]" --include="*.cpp" --include="*.h" .; then
          echo "WARNING: Potential hardcoded password found"
        fi
        
        if grep -r -i "api[_-]?key\s*=\s*['\"]" --include="*.cpp" --include="*.h" .; then
          echo "WARNING: Potential hardcoded API key found"
        fi
        
        if grep -r -i "secret\s*=\s*['\"]" --include="*.cpp" --include="*.h" .; then
          echo "WARNING: Potential hardcoded secret found"
        fi
        
        echo "Secret scan complete"
    
    - name: Security report summary
      if: always()
      run: |
        echo "=== Security Audit Summary ==="
        echo "Timestamp: $(date)"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "Scans completed:"
        echo "  ✓ Dependency vulnerability scan (Trivy)"
        echo "  ✓ Static analysis (cppcheck)"
        echo "  ✓ Secret detection"
        echo ""
        echo "Review the detailed results above for any issues found."
