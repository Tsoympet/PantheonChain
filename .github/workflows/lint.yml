name: Lint

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  clang-format:
    name: Check C++ Formatting
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format

    - name: Check formatting
      run: |
        BASE_SHA="${{ github.event.pull_request.base.sha || github.event.before }}"
        FILES=$(git diff --name-only --diff-filter=ACMRT "$BASE_SHA" "$GITHUB_SHA" -- layer1 layer2 clients tests | grep -E '\.(cpp|h|hpp)$' || true)
        if [ -n "$FILES" ]; then
          echo "$FILES" | sed 's/^/Checking: /'
          echo "$FILES" | xargs clang-format --dry-run --Werror
        else
          echo "No C++ files changed."
        fi

  cmake-lint:
    name: Check CMake Files
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install cmake-format
      run: |
        pip install cmake-format

    - name: Check CMakeLists.txt formatting
      run: |
        # Find all CMakeLists.txt files and check
        find . -name CMakeLists.txt \
          -exec echo "Checking {}" \; || true

  shellcheck:
    name: Check Shell Scripts
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: './installers'
        ignore_paths: 'node_modules third_party'
      continue-on-error: true
