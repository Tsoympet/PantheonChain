name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Debug

jobs:
  test-ubuntu:
    name: Test (Ubuntu with Coverage)
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        submodules: false
        fetch-depth: 0

    - name: Initialize submodules
      run: |
        git submodule sync --recursive
        git -c http.https://github.com/.extraheader= submodule update --init --recursive --depth=1

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          libssl-dev \
          libboost-system-dev \
          libboost-filesystem-dev \
          libboost-thread-dev \
          libboost-program-options-dev \
          ninja-build \
          lcov

    - name: Configure CMake with coverage
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DPARTHENON_REQUIRE_REAL_DEPS=ON \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
          -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
          -GNinja

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose

    - name: Generate coverage report
      run: |
        lcov --directory build --capture --output-file coverage.info --rc lcov_branch_coverage=0 || true
        lcov --remove coverage.info \
          '/usr/*' \
          '*/third_party/*' \
          '*/tests/*' \
          '*/build/*' \
          --output-file coverage.info --rc lcov_branch_coverage=0 || true
        lcov --list coverage.info --rc lcov_branch_coverage=0 || true

  test-macos:
    name: Test (macOS)
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        submodules: false
        fetch-depth: 0

    - name: Initialize submodules
      run: |
        git submodule sync --recursive
        git -c http.https://github.com/.extraheader= submodule update --init --recursive --depth=1

    - name: Install dependencies
      run: |
        brew install cmake openssl boost ninja

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DPARTHENON_REQUIRE_REAL_DEPS=ON \
          -GNinja

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose

  test-windows:
    name: Test (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        submodules: false
        fetch-depth: 0

    - name: Initialize submodules
      run: |
        git submodule sync --recursive
        git -c http.https://github.com/.extraheader= submodule update --init --recursive --depth=1

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies
      run: |
        $packages = @(
          @{ Name = "cmake"; Command = "cmake" },
          @{ Name = "ninja"; Command = "ninja" }
        )

        foreach ($package in $packages) {
          if (-not (Get-Command $package.Command -ErrorAction SilentlyContinue)) {
            choco install $package.Name -y
          }
          else {
            Write-Host "$($package.Command) already available; skipping Chocolatey install."
          }
        }

        $opensslPaths = @(
          "C:\Program Files\OpenSSL-Win64",
          "C:\Program Files\OpenSSL",
          "C:\Program Files (x86)\OpenSSL-Win64",
          "C:\Program Files (x86)\OpenSSL"
        )
        $opensslAlreadyInstalled = $opensslPaths | Where-Object { Test-Path $_ } | Select-Object -First 1
        if ($opensslAlreadyInstalled) {
          Write-Host "OpenSSL already installed at $opensslAlreadyInstalled; skipping Chocolatey install."
        } else {
          choco install openssl -y
        }

    - name: Configure CMake
      run: |
        $opensslPaths = @(
          "$env:ProgramFiles\OpenSSL-Win64",
          "$env:ProgramFiles\OpenSSL",
          "${env:ProgramFiles(x86)}\OpenSSL-Win64",
          "${env:ProgramFiles(x86)}\OpenSSL"
        )

        $opensslRoot = $opensslPaths | Where-Object { Test-Path $_ } | Select-Object -First 1

        if (-not $opensslRoot) {
          $opensslCandidates = @()
          $opensslCandidates += Get-ChildItem -Path $env:ProgramFiles -Directory -Filter 'OpenSSL*' -ErrorAction SilentlyContinue
          $programFilesX86 = ${env:ProgramFiles(x86)}
          if ($programFilesX86) {
            $opensslCandidates += Get-ChildItem -Path $programFilesX86 -Directory -Filter 'OpenSSL*' -ErrorAction SilentlyContinue
          }
          $opensslRoot = $opensslCandidates | Sort-Object -Property Name -Descending | Select-Object -First 1 -ExpandProperty FullName
        }

        if (-not $opensslRoot) {
          throw 'OpenSSL installation not found. Available paths checked: ' + ($opensslPaths -join ', ')
        }

        Write-Host "Using OpenSSL at: $opensslRoot"
        cmake -B build `
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
          -DPARTHENON_REQUIRE_REAL_DEPS=ON `
          -DOPENSSL_ROOT_DIR="$opensslRoot" `
          -GNinja

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose
