name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release

jobs:
  build-ubuntu:
    name: Build (Ubuntu)
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        submodules: false
        fetch-depth: 0

    - name: Initialize submodules
      run: |
        git submodule sync --recursive
        git -c http.https://github.com/.extraheader= submodule update --init --recursive --depth=1

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          libssl-dev \
          libboost-system-dev \
          libboost-filesystem-dev \
          libboost-thread-dev \
          libboost-program-options-dev \
          ninja-build

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DPARTHENON_REQUIRE_REAL_DEPS=ON \
          -GNinja

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel

    - name: Upload build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: ubuntu-build
        path: build/
        retention-days: 7

  build-macos:
    name: Build (macOS)
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        submodules: false
        fetch-depth: 0

    - name: Initialize submodules
      run: |
        git submodule sync --recursive
        git -c http.https://github.com/.extraheader= submodule update --init --recursive --depth=1

    - name: Install dependencies
      run: |
        brew install cmake openssl boost ninja

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DPARTHENON_REQUIRE_REAL_DEPS=ON \
          -GNinja

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel

    - name: Upload build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: macos-build
        path: build/
        retention-days: 7

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        submodules: false
        fetch-depth: 0

    - name: Initialize submodules
      run: |
        git submodule sync --recursive
        git -c http.https://github.com/.extraheader= submodule update --init --recursive --depth=1

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies
      run: |
        $packages = @(
          @{ Name = "cmake"; Command = "cmake" },
          @{ Name = "ninja"; Command = "ninja" }
        )

        foreach ($package in $packages) {
          if (-not (Get-Command $package.Command -ErrorAction SilentlyContinue)) {
            choco install $package.Name -y
          }
          else {
            Write-Host "$($package.Command) already available; skipping Chocolatey install."
          }
        }

        choco install openssl -y

    - name: Configure CMake
      run: |
        $opensslLocations = @(
          "C:\Program Files\OpenSSL-Win64",
          "C:\Program Files\OpenSSL",
          "C:\Program Files (x86)\OpenSSL-Win64",
          "C:\Program Files (x86)\OpenSSL"
        )
        if ($env:OPENSSL_ROOT_DIR) {
          $opensslLocations = @($env:OPENSSL_ROOT_DIR) + $opensslLocations
        }
        
        $opensslRoot = $opensslLocations | Where-Object { Test-Path $_ } | Select-Object -First 1
        
        if (-not $opensslRoot) {
          throw "OpenSSL not found. Searched: $($opensslLocations -join ', ')"
        }
        
        Write-Host "Found OpenSSL at: $opensslRoot"
        cmake -B build `
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
          -DPARTHENON_REQUIRE_REAL_DEPS=ON `
          -DOPENSSL_ROOT_DIR=$opensslRoot `
          -GNinja

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel

    - name: Upload build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: windows-build
        path: build/
        retention-days: 7
