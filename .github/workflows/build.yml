name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release

jobs:
  build-ubuntu:
    name: Build (Ubuntu)
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0

    - name: Initialize submodules
      run: |
        git submodule sync --recursive
        git -c http.https://github.com/.extraheader= submodule update --init --recursive --depth=1

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          libssl-dev \
          libboost-system-dev \
          libboost-filesystem-dev \
          libboost-thread-dev \
          libboost-program-options-dev \
          ninja-build

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -GNinja

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ubuntu-build
        path: build/
        retention-days: 7

  build-macos:
    name: Build (macOS)
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0

    - name: Initialize submodules
      run: |
        git submodule sync --recursive
        git -c http.https://github.com/.extraheader= submodule update --init --recursive --depth=1

    - name: Install dependencies
      run: |
        brew install cmake openssl boost ninja

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -GNinja

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: build/
        retention-days: 7

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false
        fetch-depth: 0

    - name: Initialize submodules
      run: |
        git submodule sync --recursive
        git -c http.https://github.com/.extraheader= submodule update --init --recursive --depth=1

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies
      run: |
        choco install cmake ninja openssl -y

    - name: Configure CMake
      run: |
        $opensslCandidates = @()
        $opensslCandidates += Get-ChildItem -Path $env:ProgramFiles -Directory -Filter 'OpenSSL*' -ErrorAction SilentlyContinue
        $programFilesX86 = ${env:ProgramFiles(x86)}
        if ($programFilesX86) {
          $opensslCandidates += Get-ChildItem -Path $programFilesX86 -Directory -Filter 'OpenSSL*' -ErrorAction SilentlyContinue
        }
        $opensslRoot = $opensslCandidates | Sort-Object -Property Name -Descending | Select-Object -First 1 -ExpandProperty FullName
        if (-not $opensslRoot) { throw 'OpenSSL installation not found in Program Files.' }
        cmake -B build `
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
          -DOPENSSL_ROOT_DIR=$opensslRoot `
          -GNinja

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --parallel

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: build/
        retention-days: 7
